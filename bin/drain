#!/bin/bash
# generate a temporary drakefile and call drake
DIR=$(pwd)
DRAIN_DIR="$(dirname "$(readlink -f "$0")")"
DRAKE_FILE=".drain.drake"
DRAKE_ARGS_FILE=`mktemp` || exit 1
args="$@"

if [ -f 'default_profile' ]; then
    set -a .
    source default_profile
fi

rm -f $DRAKE_FILE
python $DRAIN_DIR/to_drakefile.py --drakeargsfile $DRAKE_ARGS_FILE --drakeoutput $DRAKE_FILE $args || exit
if [ -s "$DRAKE_FILE" ]; then # if DRAKE_FILE is not empty, i.e. to_drakefile did preview
    drake_args=$(cat $DRAKE_ARGS_FILE)
    if [ -z "$drake_args" ]; then
        drake --tmpdir=$DIR/.drake --logfile=$DIR/drake.log -w $DRAKE_FILE
    else
        drake --tmpdir=$DIR/.drake --logfile=$DIR/drake.log -w $DRAKE_FILE $drake_args
    fi
fi
